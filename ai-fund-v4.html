<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AI èµ„é‡‘ç®¡ç†åŠ©æ‰‹</title>
  <style>
    :root {
      --primary-color: #EB3223;
      --primary-light: #FDF2F2;
      --bg-color: #F7F8FA;
      --text-main: #1F2D3D;
      --text-sub: #8A8F99;
      --card-bg: #FFFFFF;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --info-color: #3182CE;
      --border-color: #EDEFF2;
      --sidebar-width: 260px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #e5e5e5;
      color: var(--text-main);
      height: 100vh;
      display: flex;
      justify-content: center;
      overflow: hidden;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      position: absolute;
      left: calc(-1 * var(--sidebar-width));
      top: 0;
      width: var(--sidebar-width);
      height: 100%;
      background: #1a1a1a;
      color: white;
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }
    .sidebar.active { transform: translateX(var(--sidebar-width)); }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid #333;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .history-list { flex: 1; overflow-y: auto; margin-top: 10px; }

    .history-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #ccc;
    }
    .history-item:hover, .history-item.active { background: #333; color: white; }
    .history-item .dot { width: 8px; height: 8px; background: var(--success-color); border-radius: 50%; }

    /* é®ç½©å±‚ */
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    .overlay.active { display: block; }

    .mobile-container {
      max-width: 430px;
      width: 100%;
      height: 100vh;
      background: var(--bg-color);
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
    }

    .header {
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 16px;
    }

    .menu-btn {
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      border-radius: 8px;
    }

    .nav-bar {
      flex: 1;
      padding: 16px 0;
      text-align: center;
      font-weight: 700;
      font-size: 17px;
      margin-right: 40px;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scroll-behavior: smooth;
    }

    .message { display: flex; gap: 10px; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.user { flex-direction: row-reverse; }

    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: bold; flex-shrink: 0;
    }
    .avatar.ai { background: var(--primary-color); color: white; border: 2px solid #fff; }
    .avatar.user { background: #CBD5E0; color: white; }

    .bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      word-break: break-word;
    }
    .ai .bubble { background: white; border-top-left-radius: 4px; color: #334155; }
    .user .bubble { background: var(--primary-color); color: white; border-top-right-radius: 4px; }

    .card { background: white; border-radius: 12px; padding: 16px; margin-top: 10px; border: 1px solid var(--border-color); }
    .card-title { font-weight: 700; font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }

    .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dotted var(--border-color); gap: 10px; }
    .data-label { color: var(--text-sub); font-size: 13px; }
    .data-value { font-weight: 600; font-size: 14px; text-align: right; }
    .data-value.highlight { color: var(--primary-color); }

    .analysis-progress { height: 8px; background: #EDEFF2; border-radius: 4px; margin: 10px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary-color); transition: width 0.5s; }

    .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .btn { padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; text-align: center; border: none; transition: all 0.2s; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-secondary { background: var(--primary-light); color: var(--primary-color); }
    .btn-ghost { background: #F7F8FA; color: var(--text-main); border: 1px solid var(--border-color); }

    .bottom-section { background: white; border-top: 1px solid var(--border-color); padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
    .quick-actions { display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto; scrollbar-width: none; }
    .quick-actions::-webkit-scrollbar { display: none; }

    .action-chip {
      white-space: nowrap;
      padding: 8px 16px;
      background: var(--primary-light);
      border: 1px solid #FED7D7;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
    }

    .input-bar { padding: 0 16px 12px; display: flex; gap: 10px; align-items: center; }
    .input-container { flex: 1; background: #F2F3F5; border-radius: 24px; padding: 10px 16px; border: 1px solid transparent; transition: all 0.2s; }
    .input-container:focus-within { background: white; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(235, 50, 35, 0.1); }
    .main-input { width: 100%; border: none; background: transparent; outline: none; font-size: 15px; }

    .upload-placeholder { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 12px 0; }
    .u-box {
      aspect-ratio: 1;
      border: 2px dashed #CBD5E0;
      border-radius: 10px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 10px; color: var(--text-sub);
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }
    .u-box.filled { border-color: var(--success-color); background: #F0FFF4; color: var(--success-color); }

    /* âœ… å¯¹è¯å†…æŠ¥å‘Šï¼šå›ºå®šé«˜åº¦ + å†…éƒ¨æ»šåŠ¨ */
    .report-in-chat {
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }
    .report-in-chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .report-in-chat-title {
      font-weight: 800;
      font-size: 14px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .report-in-chat-body {
      max-height: 360px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
      background: #fff;
    }
    .report-in-chat-footer {
      padding: 10px 12px;
      border-top: 1px solid var(--border-color);
      background: rgba(255,255,255,0.96);
    }

    /* æŠ¥å‘Šå†…å°æ ‡ç­¾ */
    details {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 12px;
      background: #fff;
    }
    summary {
      cursor: pointer;
      font-weight: 800;
      color: var(--text-main);
      list-style: none;
    }
    summary::-webkit-details-marker { display: none; }
  </style>
</head>

<body>
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>ğŸ“– å†å²è®°å½•</span>
    </div>

    <div class="history-list">
      <div class="history-item active" onclick="resetApp()">
        <div class="dot"></div>
        <span>æ–°ç”¨æˆ· (é¦–æ¬¡è¿›å…¥)</span>
      </div>

      <div class="history-item" onclick="scenarioDueSoon && scenarioDueSoon()">
        <div class="dot" style="background: var(--warning-color);"></div>
        <span>ä¸´æœŸæé†’ï¼ˆâ‰¤7å¤©ï¼‰</span>
      </div>

      <div class="history-item" onclick="scenarioOverdue && scenarioOverdue()">
        <div class="dot" style="background: var(--primary-color);"></div>
        <span>é€¾æœŸæé†’ï¼ˆOverdueï¼‰</span>
      </div>

      <div class="history-item" onclick="scenarioAllPaid && scenarioAllPaid()">
        <div class="dot" style="background: var(--success-color);"></div>
        <span>æœ¬æœˆå·²è¿˜æ¸…</span>
      </div>

      <div class="history-item" onclick="scenarioShortfall && scenarioShortfall()">
        <div class="dot" style="background: var(--warning-color);"></div>
        <span>èµ„é‡‘ç¼ºå£</span>
      </div>
    </div>

    <div style="padding: 20px; font-size: 12px; color: #666;">
      ç‰ˆæœ¬: v2.6.0 (AI å†…æ ¸)
    </div>
  </div>

  <!-- é®ç½© -->
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <div class="mobile-container">
    <div class="header">
      <div class="menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </div>
      <nav class="nav-bar">ğŸ¤– AI èµ„é‡‘ç®¡ç†ç®¡å®¶</nav>
    </div>

    <div class="chat-container" id="chatBox"></div>

    <div class="bottom-section">
      <div class="quick-actions">
        <button class="action-chip" onclick="flowLoan()">â• æ–°å¢è´·æ¬¾</button>
        <button class="action-chip" onclick="flowIncome()">ğŸ’° å½•æ”¶å…¥</button>
        <button class="action-chip" onclick="flowExpense()">ğŸ’¸ è®°æ”¯å‡º</button>
        <button class="action-chip" onclick="flowAnalyze()">ğŸ“Š æ·±åº¦åˆ†ææŠ¥å‘Š</button>
      </div>

      <div class="input-bar">
        <div class="input-container">
          <input
            type="text"
            class="main-input"
            id="userInput"
            placeholder="ä¾‹å¦‚ï¼šåˆšæ‰åƒé¥­èŠ±äº†30..."
            onkeydown="if(event.key==='Enter') handleSend()"
          />
        </div>
        <button onclick="handleSend()" style="background:none; border:none; color:var(--primary-color); display:flex;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

<script>
  const chatBox = document.getElementById('chatBox');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  let userState = { loan: 0, income: 0, expense: 0, reportGenerated: false };

  function toggleSidebar() {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  function setActiveHistory(labelText) {
    document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
    const target = Array.from(document.querySelectorAll('.history-item span'))
      .find(s => s.textContent.includes(labelText));
    if (target) target.closest('.history-item').classList.add('active');
  }

  function appendMsg(role, content) {
    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    msg.innerHTML = `
      <div class="avatar ${role}">${role === 'ai' ? 'AI' : 'æˆ‘'}</div>
      <div class="bubble">${content}</div>
    `;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
    return msg;
  }

  function markUpload(el) {
    el.classList.add('filled');
    el.innerHTML = '<span>âœ…</span>å·²å°±ç»ª';
  }

  /* ===============================
     é¢„è®¾é—®é¢˜ + é¢„è®¾ç­”æ¡ˆï¼ˆæˆå“ï¼‰
     =============================== */
  const PRESET_QA = {
    safePay: {
      question: 'æˆ‘è¿™å‘¨æœ€å¤šè¿˜èƒ½è¿˜å¤šå°‘é’±æ¯”è¾ƒå®‰å…¨ï¼Ÿ',
      answer: `
        <div>
          æˆ‘å·²ç»æŒ‰ã€Œä¸å½±å“åŸºæœ¬ç”Ÿæ´» + ä¸æ–­ç°é‡‘æµã€å¸®ä½ ç®—è¿‡äº† ğŸ‘‡<br><br>
          <div class="card">
            <div class="card-title">ğŸ“Œ æœ¬å‘¨å®‰å…¨è¿˜æ¬¾ä¸Šé™</div>
            <div class="data-row"><span class="data-label">å½“å‰å¯ç”¨ç°é‡‘</span><span class="data-value">Rp 2,300,000</span></div>
            <div class="data-row"><span class="data-label">æœ€ä½ç”Ÿæ´»é¢„ç•™</span><span class="data-value">Rp 500,000</span></div>
            <div class="data-row"><span class="data-label">æœ¬å‘¨å¿…è¦æ”¯å‡º</span><span class="data-value">Rp 900,000</span></div>
            <div class="data-row" style="border-bottom:none;">
              <span class="data-label"><strong>å»ºè®®æœ¬å‘¨æœ€å¤šè¿˜</strong></span>
              <span class="data-value highlight" style="font-size:16px;">Rp 900,000</span>
            </div>
          </div>
          <div style="font-size:13px; color:#475569; margin-top:10px; line-height:1.6;">
            è¿™ä¸ªé‡‘é¢å¯ä»¥ä¼˜å…ˆå‹ä½é«˜é£é™©è´¦å•ï¼ŒåŒæ—¶ä¸ä¼šå½±å“ä½ çš„åŸºæœ¬ç”Ÿæ´»ã€‚
          </div>
          <div style="margin-top:12px;">éœ€è¦æˆ‘æŠŠè¿™ Rp 900,000 æŒ‰ã€Œæœ€é˜²é€¾æœŸã€å¸®ä½ åˆ†é…å—ï¼Ÿ</div>
        </div>
      `
    },
    noLoanRisk: {
      question: 'å¦‚æœæˆ‘ä¸å€Ÿæ–°é’±ï¼Œä¼šæœ‰ä»€ä¹ˆé£é™©ï¼Ÿ',
      answer: `
        <div>
          æˆ‘ç›´æ¥å‘Šè¯‰ä½ <strong>æœ€å¯èƒ½å‘ç”Ÿçš„æƒ…å†µ</strong> ğŸ‘‡<br><br>
          <div class="card">
            <div class="card-title">âš ï¸ ä¸å€Ÿæ–°é’±çš„é£é™©è¯„ä¼°</div>
            <div class="data-row"><span class="data-label">çŸ­æœŸç»“æœ</span><span class="data-value" style="color:#C62828;font-weight:800;">éƒ¨åˆ†è´¦å•é€¾æœŸ</span></div>
            <div class="data-row"><span class="data-label">é¢å¤–æˆæœ¬</span><span class="data-value">çº¦ Rp 120,000 / å‘¨</span></div>
            <div class="data-row" style="border-bottom:none;"><span class="data-label">ä¿¡ç”¨å½±å“</span><span class="data-value">ä¸­ç­‰ï¼ˆä¸ä¼šç«‹åˆ»å°å·ï¼‰</span></div>
          </div>
          <div style="font-size:13px; color:#475569; margin-top:10px; line-height:1.6;">
            é«˜åˆ©ç‡è´¦å•ä¼šä¼˜å…ˆæ”¾å¤§æˆæœ¬ï¼Œä½†å¹¶ä¸ä¼šé©¬ä¸Šå½±å“å…¨éƒ¨è´¦æˆ·ã€‚
          </div>
          <div style="margin-top:12px; padding:12px; background:#FFF7ED; border-radius:8px;">
            <strong>æ›´ç¨³çš„åšæ³•ï¼š</strong><br>
            ä¸æ˜¯ã€Œå€Ÿ or ä¸å€Ÿã€ï¼Œè€Œæ˜¯<strong>åªå€Ÿæœ€ä½åˆ©ç‡çš„ä¸€å°éƒ¨åˆ†</strong>æ¥å‹ä½æœ€é«˜é£é™©è´¦å•ã€‚
          </div>
          <div style="margin-top:12px;">ä½ å¸Œæœ›æˆ‘ç»™ä½ ã€Œå®Œå…¨ä¸å€Ÿã€è¿˜æ˜¯ã€Œåªå€Ÿä¸€ç‚¹ç‚¹ã€çš„æ–¹æ¡ˆï¼Ÿ</div>
        </div>
      `
    }
  };

  function askPreset(key) {
    const qa = PRESET_QA[key];
    if (!qa) return;
    appendMsg('user', qa.question);
    setTimeout(() => appendMsg('ai', qa.answer), 250);
  }

  // âœ…âœ…âœ… åœ¨å¯¹è¯é‡Œæ’å…¥â€œå¯æ»šåŠ¨æŠ¥å‘Šçª—å£â€ï¼ˆå·²å»æ‰â€œé—®AIç”Ÿæˆå¯æ‰§è¡Œæ–¹æ¡ˆâ€æŒ‰é’®ï¼‰
  function appendReport(reportInnerHTML) {
    const shell = `
      <div class="report-in-chat">
        <div class="report-in-chat-header">
          <div class="report-in-chat-title">ğŸ“Š æ™ºèƒ½èµ„é‡‘ç®¡ç†æŠ¥å‘Š</div>
          <span style="font-size:12px; color:#8A8F99;">å¯ä¸Šä¸‹æ»‘åŠ¨</span>
        </div>

        <div class="report-in-chat-body">
          ${reportInnerHTML}
        </div>

        <div class="report-in-chat-footer">
          <div style="font-size:13px; color:#334155; margin-bottom:8px;">
            ä½ å¯ä»¥ç»§ç»­é—®æˆ‘ï¼š
          </div>
          <div class="btn-group" style="margin-top:0;">
            <button class="btn btn-primary" onclick="askPreset('safePay')">æˆ‘è¿™å‘¨æœ€å¤šè¿˜èƒ½è¿˜å¤šå°‘é’±ï¼Ÿ</button>
            <button class="btn btn-secondary" onclick="askPreset('noLoanRisk')">å¦‚æœæˆ‘ä¸å€Ÿæ–°é’±ä¼šæ€æ ·ï¼Ÿ</button>
          </div>
        </div>
      </div>
    `;
    appendMsg('ai', shell);
  }

  function buildReportHTML({ debtRatio, expenseRatio, status, statusColor, income, expense, loan }) {
    return `
      <div class="card" style="margin-top:0;">
        <div class="card-title">ğŸ“Œ æœ€é‡è¦ä¿¡æ¯</div>
        <div class="data-row">
          <span class="data-label">å€ºåŠ¡å‹åŠ›</span>
          <span class="data-value" style="color:${statusColor}; font-weight:800;">
            ${status} (${debtRatio.toFixed(1)}%)
          </span>
        </div>
        <div class="analysis-progress">
          <div class="progress-fill" style="width:${Math.min(debtRatio,100)}%; background:${statusColor};"></div>
        </div>
        <div style="margin-top:10px; font-size:12px; color:#555; line-height:1.6">
          æ”¯å‡ºå æ¯”ï¼š${expenseRatio.toFixed(1)}%<br>
          å»ºè®®ï¼šä¼˜å…ˆå¤„ç†é«˜æˆæœ¬/ä¸´æœŸè´¦å•ï¼Œä¿ç•™åŸºæœ¬ç”Ÿæ´»ç°é‡‘ã€‚
        </div>
      </div>

      <details open>
        <summary>ğŸ“Š åŸºç¡€æ•°æ®</summary>
        <div class="data-row"><span class="data-label">æœˆæ€»æ”¶å…¥</span><span class="data-value">Rp ${income.toLocaleString()}</span></div>
        <div class="data-row"><span class="data-label">æœˆæ€»æ”¯å‡º</span><span class="data-value">Rp ${expense.toLocaleString()}</span></div>
        <div class="data-row" style="border-bottom:none;"><span class="data-label">æœˆæ€»å€ºåŠ¡</span><span class="data-value">Rp ${loan.toLocaleString()}</span></div>
      </details>

      <details>
        <summary>âœ… ä¸‹ä¸€æ­¥å»ºè®®</summary>
        <div style="font-size:13px; color:#334155; line-height:1.7; margin-top:8px;">
          1) æ›´æ–°æœ¬å‘¨æ”¶å…¥/æ”¯å‡ºï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰<br>
          2) æˆ‘ä¼šæŒ‰â€œåˆ°æœŸæ›´è¿‘ + æˆæœ¬æ›´é«˜â€æ’åºè´¦å•<br>
          3) ç”Ÿæˆå¯æ‰§è¡Œçš„åˆ†é˜¶æ®µè¿˜æ¬¾è®¡åˆ’
        </div>
      </details>

      <details>
        <summary>ğŸ§¾ è¿˜æ¬¾ä¼˜å…ˆçº§ï¼ˆç¤ºä¾‹ï¼‰</summary>
        <div style="font-size:13px; color:#334155; line-height:1.7; margin-top:8px;">
          â€¢ Akulakuï¼ˆ3å¤©ï¼‰ä¼˜å…ˆ<br>
          â€¢ Kredivoï¼ˆ6å¤©ï¼‰å…¶æ¬¡<br>
          ï¼ˆåç»­æ¥çœŸå®è´¦å•åä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
        </div>
      </details>
    `;
  }

  // -----------------------------
  // å…¥å£ï¼šæ–°ç”¨æˆ·ï¼ˆé¦–æ¬¡è¿›å…¥ï¼‰
  // -----------------------------
  function resetApp() {
    chatBox.innerHTML = '';
    userState = { loan: 0, income: 0, expense: 0, reportGenerated: false };
    setActiveHistory('æ–°ç”¨æˆ·');

    appendMsg('ai', `
      <div>
        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½è´¢åŠ¡åŠ©æ‰‹ã€‚æˆ‘å°†ååŠ©ä½ å®Œæˆè´¢åŠ¡å¥åº·æ¢³ç†ã€‚<br><br>
        æˆ‘ä»¬å°†åˆ†ä¸‰æ­¥è¿›è¡Œï¼š<br>
        <strong>1. è¯†åˆ«è´·æ¬¾æƒ…å†µ</strong> (ç¬¬ä¸€æ­¥)<br>
        2. è®°å½•æœˆåº¦æ”¶å…¥<br>
        3. è¿½è¸ªæ—¥å¸¸æ”¯å‡º<br><br>
        <span style="color: var(--primary-color);"><strong>[æ­¥éª¤ 1/3]</strong> è¯·ä¸Šä¼ ä½ çš„è´·æ¬¾é¢åº¦é¡µæˆ–è´¦å•é¡µæˆªå›¾ï¼š</span>
      </div>
    `);

    flowLoan();

    if (sidebar.classList.contains('active')) toggleSidebar();
  }
  // -----------------------------
  // åœºæ™¯ï¼šä¸´æœŸæé†’ï¼ˆâ‰¤7å¤©ï¼‰
  // -----------------------------
  function scenarioDueSoon() {
    chatBox.innerHTML = '';
    setActiveHistory('ä¸´æœŸæé†’');

    // æ¼”ç¤ºæ•°æ®
    userState = { loan: 128450000, income: 10000000, expense: 6000000 };

    appendMsg('ai', `
      <div>
        æˆ‘çœ‹åˆ°æœ‰å‡ ç¬”è´¦å• <strong>å³å°†åˆ°è¿˜æ¬¾æ—¥æœŸ</strong>ã€‚<br>
        å»ºè®®ä½ ä¼˜å…ˆå¤„ç†åˆ°æœŸæ›´è¿‘ã€æˆæœ¬æ›´é«˜çš„è´¦å•ï¼Œä»¥å‡å°‘é¢å¤–è´¹ç”¨ã€‚
      </div>
    `);

    appendMsg('ai', `
      <div class="card">
        <div class="card-title">â° ä¸´æœŸè´¦å•æé†’</div>

        <div class="data-row">
          <span class="data-label">Akulaku</span>
          <span class="data-value highlight">3 å¤©ååˆ°æœŸ</span>
        </div>
        <div class="data-row">
          <span class="data-label">åº”è¿˜é‡‘é¢</span>
          <span class="data-value">Rp 3,500,000</span>
        </div>

        <div class="data-row" style="margin-top:10px;">
          <span class="data-label">Kredivo</span>
          <span class="data-value" style="color: var(--warning-color); font-weight:700;">6 å¤©ååˆ°æœŸ</span>
        </div>
        <div class="data-row">
          <span class="data-label">åº”è¿˜é‡‘é¢</span>
          <span class="data-value">Rp 1,200,000</span>
        </div>

        <div style="margin-top:12px; padding:12px; background:#F8F9FA; border-radius:8px; border-left:4px solid var(--warning-color)">
          <div style="font-size:12px; color:#555; line-height:1.5">
            å°æç¤ºï¼šå¦‚æœä½  <strong>æå‰è¿˜æ¬¾</strong> æˆ–æŒ‰æ—¶å¤„ç†ä¸´æœŸè´¦å•ï¼Œé€šå¸¸èƒ½å‡å°‘é¢å¤–è´¹ç”¨å¹¶é™ä½é€¾æœŸé£é™©ã€‚
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="dueSoonActionPay()">æˆ‘å‡†å¤‡å¤„ç†è¿˜æ¬¾</button>
          <button class="btn btn-secondary" onclick="dueSoonAskChange()">æˆ‘è¿‘æœŸæ”¶æ”¯æœ‰å˜åŒ–</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','å¥½çš„ã€‚å¦‚æœä½ éœ€è¦æˆ‘é‡æ–°æ’åºä¼˜å…ˆçº§æˆ–ç”Ÿæˆè¿˜æ¬¾è®¡åˆ’ï¼Œéšæ—¶ç‚¹ã€Œæ™ºèƒ½åˆ†æã€ã€‚')">æš‚æ—¶ä¸å¤„ç†</button>
        </div>
      </div>
    `);

    if (sidebar.classList.contains('active')) toggleSidebar();
  }

  function dueSoonActionPay() {
    appendMsg('ai', `
      <div>
        å¥½çš„ã€‚ä½ æƒ³å…ˆå¤„ç†å“ªä¸€ç¬”ï¼Ÿ<br><br>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="markDueSoonPaid('Akulaku')">å…ˆè¿˜ Akulakuï¼ˆ3å¤©ï¼‰</button>
          <button class="btn btn-secondary" onclick="markDueSoonPaid('Kredivo')">å…ˆè¿˜ Kredivoï¼ˆ6å¤©ï¼‰</button>
        </div>
      </div>
    `);
  }

  function markDueSoonPaid(platform) {
    appendMsg('ai', `
      <div>
        æ˜ç™½äº†ã€‚å®Œæˆè¿˜æ¬¾åä½ å¯ä»¥ç‚¹ä¸‹é¢ç¡®è®¤ï¼Œæˆ‘ä¼šæ›´æ–°çŠ¶æ€å¹¶é‡ç®—å»ºè®®ã€‚<br><br>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="appendMsg('ai','âœ… å·²è®°å½•ï¼š${platform} æœ¬æœŸå·²å¤„ç†ã€‚æˆ‘å°†æ›´æ–°ä½ çš„æœ¬æœˆè¿˜æ¬¾è¿›åº¦ã€‚')">æˆ‘å·²è¿˜æ¬¾</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','æ²¡é—®é¢˜ã€‚å¦‚æœä½ éœ€è¦æ‹†åˆ†æˆæ›´è½»çš„æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ä½ æœ¬å‘¨æœ€å¤šèƒ½è¿˜å¤šå°‘ã€‚')">æˆ‘è¿˜ä¸äº†ï¼Œæƒ³è°ƒæ•´</button>
        </div>
      </div>
    `);
  }

  function dueSoonAskChange() {
    appendMsg('ai', `
      <div>
        å¥½çš„ã€‚æ”¶æ”¯å˜åŒ–ä¼šå½±å“è¿˜æ¬¾å®‰æ’ã€‚<br>
        ä½ å¯ä»¥ç›´æ¥è¾“å…¥ï¼š<br>
        â€¢ å·¥èµ„ 10000<br>
        â€¢ æˆ¿ç§Ÿ 10000<br><br>
        æˆ–è€…ç‚¹ä¸‹é¢å¿«é€Ÿè®°å½•ï¼š
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="flowIncome()">æ–°å¢æ”¶å…¥</button>
          <button class="btn btn-secondary" onclick="flowExpense()">æ–°å¢æ”¯å‡º</button>
        </div>
      </div>
    `);
  }

  // -----------------------------
  // åœºæ™¯ï¼šé€¾æœŸæé†’ï¼ˆOverdueï¼‰
  // -----------------------------
  function scenarioOverdue() {
    chatBox.innerHTML = '';
    setActiveHistory('é€¾æœŸæé†’');

    userState = { loan: 128450000, income: 10000000, expense: 6500000 };

    appendMsg('ai', `
      <div>
        <strong style="color: var(--primary-color);">éœ€è¦æ‚¨ç«‹å³ç¡®è®¤ï¼š</strong><br>
        æˆ‘å‘ç°è´¦å•å·²ç»<strong>è¶…è¿‡è¿˜æ¬¾æ—¥æœŸ</strong>ã€‚<br>
        æ‚¨æ˜¯å¦å·²ç»å®Œæˆè¿˜æ¬¾ï¼Ÿï¼ˆå…ˆç¡®è®¤çŠ¶æ€ï¼Œæˆ‘å†ç»§ç»­ç»™æ‚¨å»ºè®®ï¼‰
      </div>
    `);

    appendMsg('ai', `
      <div class="card">
        <div class="card-title">ğŸš¨ é€¾æœŸè´¦å•æé†’</div>

        <div class="data-row">
          <span class="data-label">Akulaku</span>
          <span class="data-value" style="color: var(--primary-color); font-weight:800;">å·²é€¾æœŸ2å¤©</span>
        </div>
        <div class="data-row">
          <span class="data-label">åº”è¿˜é‡‘é¢</span>
          <span class="data-value highlight">1,200,000 å°å°¼ç›¾</span>
        </div>
        <div class="data-row">
          <span class="data-label">åŸè¿˜æ¬¾æ—¥</span>
          <span class="data-value">02æœˆ08æ—¥</span>
        </div>

        <div style="margin-top:12px; padding:12px; background:#F8F9FA; border-radius:8px; border-left:4px solid var(--primary-color)">
          <div style="font-size:12px; color:#555; line-height:1.5">
            å¦‚æœå¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šäº§ç”Ÿ<strong>é¢å¤–è´¹ç”¨</strong>ï¼Œå¹¶å¯èƒ½å½±å“<strong>ä¿¡ç”¨è®°å½•</strong>ã€‚<br>
            æˆ‘å¯ä»¥å°½åŠ›é™ä½å½±å“å¹¶è°ƒæ•´åç»­è¿˜æ¬¾å®‰æ’ã€‚
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="overduePaid()">æˆ‘è¿˜äº†</button>
          <button class="btn btn-secondary" onclick="overdueNotPaid()">è¿˜æ²¡ï¼Œå¸®æˆ‘çœ‹çœ‹æ€ä¹ˆåŠ</button>
          <button class="btn btn-ghost" onclick="overdueCashTight()">æˆ‘ç°åœ¨èµ„é‡‘ç´§å¼ </button>
        </div>
      </div>
    `);

    if (sidebar.classList.contains('active')) toggleSidebar();
  }

  function overduePaid() {
    appendMsg('ai', `
      <div>
        å¥½çš„ï¼Œæˆ‘å…ˆå¸®ä½ æŠŠè´¦å•æ ‡è®°ä¸º<strong>å·²è¿˜</strong>ã€‚<br>
        <span style="color: var(--text-sub); font-size: 12px;">å¦‚æœä½ æ„¿æ„ï¼Œä¹Ÿå¯ä»¥è¡¥å……è¿˜æ¬¾é‡‘é¢/æˆªå›¾è®©æˆ‘æ›´å‡†ç¡®æ›´æ–°ã€‚</span>
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="appendMsg('ai','âœ… è®°å½•ï¼šAkulakuæœ¬æœŸå·²è¿˜ã€‚æˆ‘å°†æ›´æ–°ä½ çš„è¿˜æ¬¾çŠ¶æ€å¹¶é‡æ–°è®¡ç®—åç»­å»ºè®®ã€‚')">ç¡®è®¤å·²è¿˜</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','ä½ å¯ä»¥ç›´æ¥ä¸Šä¼ è¿˜æ¬¾å‡­è¯/æˆªå›¾ï¼ˆä»»é€‰ï¼‰ï¼Œæˆ‘ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åŒæ­¥ã€‚')">ä¸Šä¼ å‡­è¯ï¼ˆä»»é€‰ï¼‰</button>
        </div>
      </div>
    `);

    setTimeout(() => {
      appendMsg('ai', `
        éœ€è¦æˆ‘é¡ºä¾¿æ£€æŸ¥ä¸€ä¸‹<strong>æœªæ¥7å¤©</strong>æ˜¯å¦è¿˜æœ‰ä¸´æœŸè´¦å•å—ï¼Ÿ
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="appendMsg('ai','å¥½çš„ï¼Œæˆ‘å¼€å§‹æ£€æŸ¥å¹¶æ•´ç†æ¥ä¸‹æ¥7å¤©çš„è¿˜æ¬¾ä¼˜å…ˆçº§ã€‚ä½ ä¹Ÿå¯ä»¥ç‚¹ã€Œæ™ºèƒ½åˆ†æã€ç”Ÿæˆå®Œæ•´æŠ¥å‘Šã€‚')">å¸®æˆ‘æ£€æŸ¥</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','å¥½çš„ã€‚å¦‚æœä»¥åéœ€è¦æˆ‘è°ƒæ•´è®¡åˆ’æˆ–è€…æé†’ä½ ï¼Œéšæ—¶æ‰¾æˆ‘ã€‚')">æš‚æ—¶ä¸ç”¨</button>
        </div>
      `);
    }, 600);
  }

  function overdueNotPaid() {
    appendMsg('ai', `
      <div>
        æˆ‘æ˜ç™½äº†ã€‚æˆ‘å»ºè®®ä½ å°½å¿«å¤„ç†é€¾æœŸè´¦å•ï¼Œä»¥é™ä½é¢å¤–è´¹ç”¨å’Œé£é™©ã€‚<br><br>
        ä½ ç°åœ¨æ›´å€¾å‘äºå“ªç§æ–¹å¼ï¼Ÿ
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="appendMsg('ai','å¥½çš„ï¼Œæˆ‘ä»¬å…ˆæŠŠAkulakuä½œä¸ºä¼˜å…ˆé¡¹ã€‚æˆ‘å¯ä»¥ç»™ä½ ä¸€ä¸ªâ€œæœ€çœæˆæœ¬â€çš„å¤„ç†é¡ºåºï¼Œå¹¶ç”Ÿæˆåç»­è®¡åˆ’ã€‚')">ä¼˜å…ˆå¤„ç†é€¾æœŸè´¦å•</button>
          <button class="btn btn-secondary" onclick="overdueAskChange()">å…ˆæ›´æ–°æˆ‘çš„æ”¶æ”¯æƒ…å†µ</button>
        </div>
      </div>
    `);
  }

  function overdueCashTight() {
    appendMsg('ai', `
      <div>
        æˆ‘ç†è§£ã€‚å¦‚æœèµ„é‡‘ç´§å¼ ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåšä¸€ä¸ªâ€œé£é™©æœ€å°åŒ–â€çš„æ–¹æ¡ˆï¼š<br>
        â€¢ ä¼˜å…ˆå¤„ç†é€¾æœŸé¡¹ç›®ï¼ˆå…ˆæŠŠé£é™©é¡¹å‹ä¸‹å»ï¼‰<br>
        â€¢ åŒæ—¶è°ƒæ•´å…¶ä»–è´¦å•é¡ºåºï¼Œé¿å…è¿é”é€¾æœŸ<br><br>
        æœ€è¿‘ä½ çš„æ”¶å…¥æˆ–æ”¯å‡ºæœ‰å˜åŒ–å—ï¼Ÿè¿™ä¼šå½±å“æˆ‘ç»™ä½ çš„æ–¹æ¡ˆã€‚
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="overdueAskChange()">æˆ‘è¿‘æœŸæ”¶æ”¯æœ‰å˜åŒ–</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','ä½ ä¹Ÿå¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘ï¼šæœ¬å‘¨æœ€å¤šè¿˜èƒ½å¤šå°‘ï¼ˆä¾‹å¦‚ï¼šæœ¬å‘¨æœ€å¤šè¿˜èƒ½300000ï¼‰ã€‚æˆ‘ä¼šæŒ‰è¿™ä¸ªé‡‘é¢ç”Ÿæˆæ‰§è¡Œæ–¹æ¡ˆã€‚')">æˆ‘æ²¡å˜åŒ–ï¼Œä½†æˆ‘èƒ½è¿˜æœ‰é™</button>
        </div>
      </div>
    `);
  }

  function overdueAskChange() {
    appendMsg('ai', `
      <div>
        å¥½çš„ã€‚ä½ å¯ä»¥ç›´æ¥è¾“å…¥ä¸€æ¡ä¿¡æ¯å³å¯ï¼š<br>
        â€¢ å·¥èµ„10000<br>
        â€¢ æˆ¿ç§Ÿ10000<br>
        â€¢ ç”µè¯1500<br><br>
        æˆ–è€…ç”¨å¿«æ·é”®å¿«é€Ÿè®°å½•ï¼š
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="flowIncome()">æ–°å¢æ”¶å…¥</button>
          <button class="btn btn-secondary" onclick="flowExpense()">æ–°å¢æ”¯å‡º</button>
        </div>
      </div>
    `);
  }

  // ---------------------------------------------------
  // âœ… æ–°å¢åœºæ™¯ï¼šæœ¬æœˆå·²è¿˜æ¸…ï¼ˆå…¨éƒ¨å·²ä»˜æ¬¾ï¼‰
  // ---------------------------------------------------
  function scenarioAllPaid() {
    chatBox.innerHTML = '';
    setActiveHistory('æœ¬æœˆå·²è¿˜æ¸…');

    // æ¼”ç¤ºï¼šæœ¬æœˆå·²å…¨éƒ¨è¿˜æ¸…ï¼ˆçœŸå®æ•°æ®æ›¿æ¢ä¸ºä½ çš„æ•°æ®æºï¼‰
    userState = {
      loan: 128450000,
      income: 10000000,
      expense: 6200000
    };

    appendMsg('ai', `
      <div>
        <strong style="color: var(--success-color);">åšå¾—å¾ˆå¥½ï¼</strong><br>
        ä½ å·²ç»å®Œæˆ<strong>æœ¬æœˆæ‰€æœ‰è¿˜æ¬¾</strong> âœ…<br>
        æˆ‘å¯ä»¥å¸®ä½ æå‰çœ‹çœ‹ä¸‹ä¸ªæœˆçš„å‹åŠ›ï¼Œå¹¶æ‰¾å‡ºèŠ‚çœåˆ©æ¯çš„æœºä¼šã€‚
      </div>
    `);

    // æ­£åé¦ˆå¡
    appendMsg('ai', `
      <div class="card">
        <div class="card-title">ğŸ‰ æœ¬æœˆè¿˜æ¬¾å®Œæˆ</div>

        <div class="data-row">
          <span class="data-label">æœ¬æœˆçŠ¶æ€</span>
          <span class="data-value" style="color: var(--success-color); font-weight:800;">å…¨éƒ¨å·²è¿˜</span>
        </div>

        <div class="data-row">
          <span class="data-label">æ¯æœˆæ”¶å…¥</span>
          <span class="data-value">Rp ${userState.income.toLocaleString()}</span>
        </div>

        <div class="data-row" style="border-bottom:none;">
          <span class="data-label">æ¯æœˆæ”¯å‡º</span>
          <span class="data-value">Rp ${userState.expense.toLocaleString()}</span>
        </div>

        <div style="margin-top:12px; padding:12px; background:#F0FFF4; border-radius:8px; border-left:4px solid var(--success-color)">
          <div style="font-size:12px; color:#2F855A; line-height:1.5">
            ç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼Œä½ çš„èµ„é‡‘å‹åŠ›ä¼šæ›´å¯æ§ã€‚<br>
            ä¸‹ä¸ªæœˆæˆ‘ä¹Ÿå¯ä»¥æå‰æé†’å…³é”®è¿˜æ¬¾æ—¥ï¼Œé¿å…ä¸´æœŸæ‰‹å¿™è„šä¹±ã€‚
          </div>
        </div>
      </div>
    `);

    // ä¸‹æœˆé¢„æµ‹å¡
    appendMsg('ai', `
      <div class="card">
        <div class="card-title">ğŸ”­ ä¸‹æœˆé¢„æµ‹ï¼ˆæ¼”ç¤ºï¼‰</div>

        <div class="data-row">
          <span class="data-label">é¢„è®¡ä¸‹æœˆåº”è¿˜</span>
          <span class="data-value highlight">Rp 4,100,000</span>
        </div>

        <div class="data-row">
          <span class="data-label">æœ€æ—©è¿˜æ¬¾æ—¥</span>
          <span class="data-value">Akulaku Â· 03æœˆ05æ—¥</span>
        </div>

        <div class="data-row" style="border-bottom:none;">
          <span class="data-label">è¿˜æ¬¾å‹åŠ›</span>
          <span class="data-value" style="color: var(--warning-color); font-weight:700;">ä¸­ç­‰</span>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="allPaidPlan()">ç”Ÿæˆä¸‹æœˆè¿˜æ¬¾è®¡åˆ’</button>
          <button class="btn btn-ghost" onclick="allPaidAskUpdate()">æ›´æ–°æˆ‘çš„æ”¶æ”¯</button>
        </div>
      </div>
    `);

    // çœåˆ©æ¯æœºä¼šå¡
    appendMsg('ai', `
      <div class="card">
        <div class="card-title">ğŸ’¡ åˆ©æ¯èŠ‚çœæœºä¼š</div>

        <div class="data-row">
          <span class="data-label">å»ºè®®åŠ¨ä½œ</span>
          <span class="data-value">æå‰å¤„ç† Akulaku</span>
        </div>

        <div class="data-row" style="border-bottom:none;">
          <span class="data-label">é¢„è®¡å¯èŠ‚çœ</span>
          <span class="data-value highlight">Rp 450,000</span>
        </div>

        <div style="margin-top:12px; padding:12px; background:#FFF5F5; border-radius:8px; border-left:4px solid var(--primary-color)">
          <div style="font-size:12px; color:#742A2A; line-height:1.5">
            å¦‚æœä½ åœ¨è¿˜æ¬¾æ—¥å‰æå‰ç»“æ¸…/è¿˜ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸å¯ä»¥å‡å°‘åˆ©æ¯æˆ–é¢å¤–è´¹ç”¨ã€‚<br>
            æˆ‘å¯ä»¥æ ¹æ®ä½ çš„åå¥½ï¼Œç»™ä½ ä¸€ä¸ªæ›´ç¨³å¦¥çš„å®‰æ’ã€‚
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="allPaidSaveInterest()">å¸®æˆ‘åšçœåˆ©æ¯æ–¹æ¡ˆ</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','å¥½çš„ã€‚å¦‚æœä½ ä¹‹åæƒ³è°ƒæ•´ä¼˜å…ˆçº§æˆ–éœ€è¦æé†’ï¼Œéšæ—¶ç‚¹ã€Œæ™ºèƒ½åˆ†æã€ã€‚')">å…ˆä¸ç”¨</button>
        </div>
      </div>
    `);

    if (sidebar.classList.contains('active')) toggleSidebar();
  }

  function allPaidPlan() {
    appendMsg('ai', `
      <div>
        å¥½çš„ã€‚æˆ‘ä¼šæ ¹æ®ä½ å½“å‰çš„æ”¶å…¥/æ”¯å‡ºä¸ä¸‹ä¸ªæœˆçš„è´¦å•ï¼Œç”Ÿæˆä¸€ä¸ªæ›´æœ‰æ•ˆçš„è®¡åˆ’ã€‚<br><br>
        æœ€è¿‘ä½ çš„æ”¶å…¥æˆ–æ”¯å‡ºæœ‰å˜åŒ–å—ï¼Ÿå¦‚æœæœ‰ï¼Œè®¡åˆ’ä¼šæ›´å‡†ç¡®ã€‚
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="allPaidAskUpdate()">æœ‰å˜åŒ–ï¼Œå…ˆæ›´æ–°</button>
          <button class="btn btn-secondary" onclick="appendMsg('ai','âœ… ä¸‹æœˆè®¡åˆ’ï¼ˆæ¼”ç¤ºï¼‰ï¼šå·²ä¼˜å…ˆ Akulakuï¼ˆ03æœˆ05æ—¥ï¼‰ï¼Œå…¶æ¬¡ Kredivoã€‚éœ€è¦æˆ‘æŒ‰â€œçœåˆ©æ¯â€æˆ–â€œç¨³å¥â€ä¸¤ç§æ–¹æ¡ˆç»™ä½ å¯¹æ¯”å—ï¼Ÿ')">æ²¡å˜åŒ–ï¼Œç›´æ¥ç”Ÿæˆ</button>
        </div>
      </div>
    `);
  }

  function allPaidAskUpdate() {
    appendMsg('ai', `
      <div>
        ä½ å¯ä»¥ç›´æ¥è¾“å…¥ä¸€æ¡ä¿¡æ¯å³å¯ï¼š<br>
        â€¢ å·¥èµ„10000<br>
        â€¢ æˆ¿ç§Ÿ10000<br>
        â€¢ ç”µè¯1500<br><br>
        æˆ–è€…ç”¨å¿«æ·é”®å¿«é€Ÿè®°å½•ï¼š
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="flowIncome()">æ–°å¢æ”¶å…¥</button>
          <button class="btn btn-secondary" onclick="flowExpense()">æ–°å¢æ”¯å‡º</button>
        </div>
      </div>
    `);
  }

  function allPaidSaveInterest() {
    appendMsg('ai', `
      <div>
        å¥½ï¼Œæˆ‘ä¼šä¼˜å…ˆç»™ä½ ä¸€ä¸ªâ€œçœåˆ©æ¯â€çš„æ–¹æ¡ˆã€‚<br>
        ä¸ºäº†æ›´å‡†ç¡®ï¼Œæˆ‘ç¡®è®¤ï¼šä½ ä¸‹ä¸ªæœˆæ˜¯å¦æ„¿æ„é¢„ç•™ä¸€éƒ¨åˆ†èµ„é‡‘ç”¨äºæå‰è¿˜æ¬¾ï¼Ÿ<br><br>
        ä½ å¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘ï¼š<br>
        â€¢ ä¸‹æœˆæˆ‘èƒ½æå‰è¿˜500000<br>
        æˆ–è€…ç‚¹ä¸‹é¢é€‰é¡¹ï¼š
        <div class="btn-group" style="margin-top:12px;">
          <button class="btn btn-primary" onclick="appendMsg('ai','æ˜ç™½äº†ã€‚æˆ‘å°†æŒ‰â€œå¯æå‰è¿˜æ¬¾â€çš„å‰æï¼Œä¼˜å…ˆä¼˜åŒ– Akulaku çš„åˆ©æ¯æˆæœ¬ï¼Œå¹¶ç”Ÿæˆå…·ä½“é¡ºåºä¸æ—¶é—´ç‚¹ã€‚')">å¯ä»¥ï¼Œç»™æˆ‘çœåˆ©æ¯æ–¹æ¡ˆ</button>
          <button class="btn btn-ghost" onclick="appendMsg('ai','æ²¡é—®é¢˜ã€‚æˆ‘ä¼šæ”¹ç”¨â€œç¨³å¥â€ç­–ç•¥ï¼Œåœ¨ä¸å½±å“ç”Ÿæ´»æ”¯å‡ºçš„æƒ…å†µä¸‹å°½é‡å‡å°‘åˆ©æ¯ã€‚')">ä¸ç¡®å®š/æš‚ä¸æå‰è¿˜</button>
        </div>
      </div>
    `);
  }
    // -----------------------------
  // èµ„é‡‘ç¼ºå£
  // -----------------------------
  function scenarioShortfall() {
  chatBox.innerHTML = '';
  if (typeof setActiveHistory === 'function') setActiveHistory('èµ„é‡‘ç¼ºå£');

  // Demoï¼šæ¨¡æ‹Ÿä¸€ä¸ªâ€œæœ¬æœˆèµ„é‡‘ä¸å¤Ÿè¦†ç›–å¾…è¿˜â€çš„çŠ¶æ€
  userState = {
    income: 10000000,
    expense: 7200000,
    due: 4800000
  };

  const available = userState.income - userState.expense;
  const gap = userState.due - available;

  appendMsg('ai', `
    <div>
      <strong style="color: var(--warning-color);">æˆ‘éœ€è¦æé†’ä½ ä¸€ä¸ªé‡è¦æƒ…å†µï¼š</strong><br>
      æŒ‰å½“å‰è®°å½•çš„æ”¶å…¥å’Œæ”¯å‡ºï¼Œ<br>
      ä½ æœ¬æœˆç”¨äºè¿˜æ¬¾çš„èµ„é‡‘ <strong>å¯èƒ½ä¸å¤Ÿ</strong>ã€‚
    </div>
  `);

  appendMsg('ai', `
    <div class="card">
      <div class="card-title">âš ï¸ èµ„é‡‘ç¼ºå£é¢„è­¦</div>

      <div class="data-row">
        <span class="data-label">æœ¬æœˆæ”¶å…¥</span>
        <span class="data-value">Rp ${userState.income.toLocaleString()}</span>
      </div>
      <div class="data-row">
        <span class="data-label">æœ¬æœˆæ”¯å‡º</span>
        <span class="data-value">Rp ${userState.expense.toLocaleString()}</span>
      </div>
      <div class="data-row">
        <span class="data-label">æœ¬æœˆå¾…è¿˜</span>
        <span class="data-value highlight">Rp ${userState.due.toLocaleString()}</span>
      </div>

      <div style="margin-top:10px; padding:12px; background:#FFF7ED; border-radius:8px; border-left:4px solid var(--warning-color)">
        <div style="font-size:12px; color:#7C2D12; line-height:1.5">
          åœ¨æ‰£é™¤å¿…è¦æ”¯å‡ºåï¼Œé¢„è®¡ä»æœ‰ <strong>Rp ${gap.toLocaleString()}</strong> çš„èµ„é‡‘ç¼ºå£ã€‚<br>
          å¦‚æœä¸è°ƒæ•´æ–¹æ¡ˆï¼Œå¯èƒ½ä¼šå¸¦æ¥é€¾æœŸæˆ–é¢å¤–è´¹ç”¨é£é™©ã€‚
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="shortfallPlan()">å¸®æˆ‘ç”Ÿæˆå¯æ‰§è¡Œæ–¹æ¡ˆ</button>
        <button class="btn btn-secondary" onclick="shortfallAskUpdate()">æ›´æ–°æ”¶å…¥ / æ”¯å‡º</button>
        <button class="btn btn-ghost" onclick="shortfallLimit()">æˆ‘åªèƒ½è¿˜ä¸€éƒ¨åˆ†</button>
      </div>
    </div>
  `);

  if (sidebar.classList.contains('active')) toggleSidebar();
}

function shortfallPlan() {
  appendMsg('ai', `
    <div>
      æˆ‘å¯ä»¥ç»™ä½ ä¸¤ç§æ–¹æ¡ˆï¼Œä½ é€‰ä¸€ç§å³å¯ï¼š<br><br>

      <strong>æ–¹æ¡ˆ Aï½œç¨³ä½ä¸é€¾æœŸ</strong><br>
      â€¢ ä¼˜å…ˆå¤„ç†é€¾æœŸ/ä¸´æœŸè´¦å•<br>
      â€¢ å…¶ä½™è´¦å•é‡‡ç”¨æœ€ä½å¯è¡Œé¢åº¦<br><br>

      <strong>æ–¹æ¡ˆ Bï½œå°½é‡çœåˆ©æ¯</strong><br>
      â€¢ ä¼˜å…ˆå¤„ç†åˆ©æ¯å’Œè´¹ç”¨æ›´é«˜çš„å¹³å°<br>
      â€¢ å¯èƒ½ä¼šæ›´å ç”¨ç°é‡‘æµ

      <div class="btn-group" style="margin-top:12px;">
        <button class="btn btn-primary" onclick="appendMsg('ai','å¥½çš„ï¼Œæˆ‘å°†æŒ‰ã€ç¨³ä½ä¸é€¾æœŸã€‘ä¸ºä½ ç”Ÿæˆå¯æ‰§è¡Œæ–¹æ¡ˆï¼Œå¹¶é‡æ–°æ’åºæœ¬æœˆè¿˜æ¬¾ä¼˜å…ˆçº§ã€‚')">é€‰æ–¹æ¡ˆ A</button>
        <button class="btn btn-secondary" onclick="appendMsg('ai','æ˜ç™½äº†ï¼Œæˆ‘å°†æŒ‰ã€å°½é‡çœåˆ©æ¯ã€‘æ–¹æ¡ˆï¼Œä¼˜å…ˆä¼˜åŒ–é«˜æˆæœ¬è´¦å•ã€‚')">é€‰æ–¹æ¡ˆ B</button>
      </div>
    </div>
  `);
}

function shortfallAskUpdate() {
  appendMsg('ai', `
    <div>
      æ”¶æ”¯å˜åŒ–ä¼šç›´æ¥å½±å“å¯ç”¨æ–¹æ¡ˆã€‚<br>
      ä½ å¯ä»¥ç›´æ¥è¾“å…¥ä¸€æ¡ï¼š<br>
      â€¢ å·¥èµ„ 10000<br>
      â€¢ æˆ¿ç§Ÿ 10000<br><br>
      æˆ–ç”¨å¿«æ·æŒ‰é’®ï¼š
      <div class="btn-group" style="margin-top:12px;">
        <button class="btn btn-primary" onclick="flowIncome()">æ–°å¢æ”¶å…¥</button>
        <button class="btn btn-secondary" onclick="flowExpense()">æ–°å¢æ”¯å‡º</button>
      </div>
    </div>
  `);
}

function shortfallLimit() {
  appendMsg('ai', `
    <div>
      æ˜ç™½ã€‚ä½ å¯ä»¥ç›´æ¥å‘Šè¯‰æˆ‘ä¸€ä¸ªä¸Šé™å³å¯ã€‚<br>
      ä¾‹å¦‚ï¼š<br>
      â€¢ æœ¬å‘¨æœ€å¤šè¿˜ 300000<br>
      â€¢ è¿™ä¸ªæœˆæœ€å¤šè¿˜ 1500000<br><br>
      æˆ‘ä¼šåœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œå¸®ä½ å®‰æ’é£é™©æœ€ä½çš„é¡ºåºã€‚
    </div>
  `);
}
  // -----------------------------
  // ä¸šåŠ¡æµï¼šè´·æ¬¾ / æ”¶å…¥ / æ”¯å‡º / åˆ†æ
  // -----------------------------
  function flowLoan() {
    appendMsg('ai', `
      <strong>[å½•å…¥è´·æ¬¾]</strong> è¯·é€‰æ‹©å¹³å°å¹¶ä¸Šä¼ æˆªå›¾ï¼š
      <div class="card">
        <select id="p_select_new" style="width:100%; padding:10px; margin-bottom:12px; border-radius:8px; border:1px solid #ddd;">
          <option>Akulaku</option>
          <option>Kredivo</option>
        </select>
        <div class="upload-placeholder">
          <div class="u-box" onclick="markUpload(this)">ğŸ“·æˆªå›¾1</div>
          <div class="u-box" onclick="markUpload(this)">ğŸ“·æˆªå›¾2</div>
          <div class="u-box" onclick="markUpload(this)">ğŸ“·è¿˜æ¬¾æ—¥</div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="confirmLoan(this)">æäº¤è¯†åˆ«</button>
      </div>
    `);
  }

  function confirmLoan(btn) {
    btn.disabled = true;
    btn.innerText = "ğŸ” AI æ­£åœ¨è§£æ...";
    setTimeout(() => {
      const amount = 5000000;
      const platform = document.getElementById('p_select_new')?.value || 'Akulaku';
      const html = `
        <div class="card">
          <div class="card-title">ğŸ” è¯†åˆ«æŠ¥å‘Š</div>
          <div class="data-row"><span class="data-label">æ£€æµ‹åˆ°å¹³å°</span><span class="data-value">${platform}</span></div>
          <div class="data-row"><span class="data-label">åº”è¿˜æ€»é¢</span><span class="data-value highlight">Rp ${amount.toLocaleString()}</span></div>
          <div class="data-row"><span class="data-label">æœ€è¿‘è¿˜æ¬¾æ—¥</span><span class="data-value">02æœˆ10æ—¥</span></div>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="saveLoanStep(${amount}, this)">ç¡®è®¤å…¥åº“</button>
            <button class="btn btn-ghost" onclick="appendMsg('ai','è¯·é‡æ–°ä¸Šä¼ æ›´æ¸…æ™°çš„æˆªå›¾ã€‚')">è¯†åˆ«æœ‰è¯¯</button>
          </div>
        </div>`;
      btn.closest('.bubble').innerHTML = html;
    }, 900);
  }

  function saveLoanStep(amt, btn) {
    userState.loan += amt;
    userState.reportGenerated = false;
    btn.closest('.bubble').innerHTML = 'âœ… è´·æ¬¾ä¿¡æ¯å·²é”å®šå…¥åº“ã€‚';
    setTimeout(() => {
      appendMsg('ai', `<strong>[æ­¥éª¤ 2/3]</strong> è´·æ¬¾å·²è¯†åˆ«ã€‚æ¥ä¸‹æ¥ï¼Œè¯·å‘Šè¯‰æˆ‘ä½ çš„<strong>æœˆæ”¶å…¥</strong>æ˜¯å¤šå°‘ï¼Ÿ<br><br>ä½ å¯ä»¥è¾“å…¥â€œå·¥èµ„10000â€æˆ–â€œæœˆè–ª8500â€ã€‚`);
    }, 600);
  }

  function flowIncome() { appendMsg('ai', 'è¯·è¾“å…¥ä½ çš„æœˆæ”¶å…¥é‡‘é¢ï¼ˆä¾‹å¦‚ï¼šå‘å·¥èµ„ 12000ï¼‰ã€‚'); }
  function flowExpense() { appendMsg('ai', 'è¯·è®°å½•ä¸€ç¬”æ”¯å‡ºï¼ˆä¾‹å¦‚ï¼šä»Šå¤©æ‰“è½¦èŠ±äº† 25ï¼‰ã€‚'); }

  function handleSend() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    appendMsg('user', text);
    input.value = '';

    const numMatch = text.replace(/,/g, '').match(/\d+(\.\d+)?/);
    const amount = numMatch ? parseFloat(numMatch[0]) : null;

    const incomeKeys = ['å·¥èµ„','æ”¶å…¥','å‘é’±','å…¥è´¦','é¢†é’±','è–ª','income'];
    const expenseKeys = ['èŠ±','ä¹°','æ¶ˆè´¹','æ”¯å‡º','æ”¯ä»˜','æ‰“è½¦','å¤–å–','è´¹','rp','å—','pay','åƒ','å–'];

    setTimeout(() => {
      if (!amount) {
        appendMsg('ai', 'æ”¶åˆ°ï¼ä½ å¯ä»¥ç»§ç»­è¾“å…¥é‡‘é¢ï¼ˆå¦‚ï¼šåƒé¥­30ï¼‰ï¼Œæˆ–è€…ç‚¹å‡»ä¸‹æ–¹åŠŸèƒ½æŒ‰é’®è¿›è¡Œæ“ä½œã€‚');
        return;
      }

      const lower = text.toLowerCase();
      const isIncome = incomeKeys.some(k => lower.includes(k.toLowerCase()));
      const isExpense = expenseKeys.some(k => lower.includes(k.toLowerCase())) || (!isIncome && text.length < 15);

      if (isIncome) {
        appendMsg('ai', `è¯†åˆ«åˆ°<strong>æ”¶å…¥</strong>ï¼šRp ${amount.toLocaleString()}<br><button class="btn btn-primary" style="margin-top:10px; width:100%" onclick="confirmRecord('income', ${amount}, this)">ç¡®è®¤å½•å…¥</button>`);
      } else if (isExpense) {
        appendMsg('ai', `è¯†åˆ«åˆ°<strong>æ”¯å‡º</strong>ï¼šRp ${amount.toLocaleString()}<br><button class="btn btn-secondary" style="margin-top:10px; width:100%" onclick="confirmRecord('expense', ${amount}, this)">ç¡®è®¤æ”¯å‡º</button>`);
      } else {
        appendMsg('ai', `
          è¯†åˆ«åˆ°æ•°å­—ï¼Œè¯·é—®è¿™æ˜¯æ”¶å…¥è¿˜æ˜¯æ”¯å‡ºï¼Ÿ
          <div class="btn-group">
            <button class="btn btn-primary" onclick="confirmRecord('income', ${amount}, this)">æ”¶å…¥</button>
            <button class="btn btn-secondary" onclick="confirmRecord('expense', ${amount}, this)">æ”¯å‡º</button>
          </div>
        `);
      }
    }, 400);
  }

  function confirmRecord(type, val, btn) {
    userState[type] += val;
    userState.reportGenerated = false;
    btn.closest('.bubble').innerHTML = `âœ… å·²è®°å…¥${type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}ï¼šRp ${val.toLocaleString()}`;

    setTimeout(() => {
      if (type === 'income' && userState.expense === 0) {
        appendMsg('ai', `<strong>[æ­¥éª¤ 3/3]</strong> æ”¶å…¥å·²è®°ä¸‹ã€‚æœ€åï¼Œå»ºè®®å½•å…¥å‡ ç¬”<strong>æ—¥å¸¸æ”¯å‡º</strong>ï¼ˆå¦‚ï¼šæˆ¿ç§Ÿã€é¥­è´¹ï¼‰ï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆå…¨æ–¹ä½çš„å¥åº·åˆ†ææŠ¥å‘Šã€‚`);
        return;
      }

      const ready = (userState.loan > 0 && userState.income > 0 && userState.expense > 0);
      if (ready && !userState.reportGenerated) {
        userState.reportGenerated = true;
        appendMsg('ai', `âœ¨ æ•°æ®å·²æ”¶é½ï¼æˆ‘ç°åœ¨ä¸ºä½ ç”Ÿæˆ<strong>æ·±åº¦åˆ†ææŠ¥å‘Š</strong>ï¼ˆæŠ¥å‘Šåœ¨å¯¹è¯ä¸­ï¼Œå¯ä¸Šä¸‹æ»‘åŠ¨ï¼‰ã€‚`);
        setTimeout(() => flowAnalyze(true), 300);
        return;
      }

      if (ready && userState.reportGenerated) {
        appendMsg('ai', `å·²æ›´æ–°è®°å½• âœ… å¦‚æœä½ æƒ³é‡æ–°è®¡ç®—æŠ¥å‘Šï¼Œå¯ä»¥ç‚¹ä¸‹æ–¹ã€Œæ·±åº¦åˆ†ææŠ¥å‘Šã€ã€‚`);
      }
    }, 700);
  }

  function flowAnalyze(auto = false) {
    if (userState.loan === 0 && userState.income === 0) {
      appendMsg('ai', 'åˆ†ææ•°æ®ä¸è¶³ã€‚è¯·å…ˆå®Œæˆã€è´·æ¬¾å½•å…¥ã€‘å’Œã€æ”¶å…¥å½•å…¥ã€‘ã€‚');
      return;
    }

    if (!auto) appendMsg('user', 'ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š');
    const loadingMsg = appendMsg('ai', 'æ­£åœ¨è°ƒç”¨ AI è´¢åŠ¡æ¨¡å‹è¿›è¡Œæ·±åº¦è®¡ç®—...');

    setTimeout(() => {
      loadingMsg.querySelector('.bubble').innerHTML = 'åˆ†æå®Œæˆï¼æŠ¥å‘Šå·²ç”Ÿæˆåœ¨å¯¹è¯ä¸­ï¼ˆå¯ä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹ï¼‰ã€‚';

      const debtRatio = ((userState.loan / (userState.income || 1)) * 100);
      const expenseRatio = ((userState.expense / (userState.income || 1)) * 100);
      const status = debtRatio > 50 ? 'å±é™©' : (debtRatio > 30 ? 'è­¦ç¤º' : 'å¥åº·');
      const statusColor = status === 'å±é™©' ? '#EB3223' : (status === 'è­¦ç¤º' ? '#FF9800' : '#4CAF50');

      const reportInnerHTML = buildReportHTML({
        debtRatio,
        expenseRatio,
        status,
        statusColor,
        income: userState.income || 0,
        expense: userState.expense || 0,
        loan: userState.loan || 0
      });

      appendReport(reportInnerHTML);
    }, 900);
  }

  window.onload = resetApp;
</script>
</body>
</html>
